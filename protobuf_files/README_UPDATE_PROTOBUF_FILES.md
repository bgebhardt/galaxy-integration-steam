# Obtaining, Parsing, and Recompiling Protobuf Files:
Unfortunately, Steam has made this more difficult. There are no official protobuf definitions for the backend calls and the ones generated by steamdatabase tend to conflict between the different services (esp. steammessages and webui have lots of overlap which causes these conflicts). Hence the updating procedure is a bit more involved than it need be. The following steps cover most of what you need to do in case the protobuf files need to be updated.

## Obtaining procedure:
1. Make sure your virtual environment has `invoke` installed. if not, install the version in `requirements/app.txt`
1. (Optional) Backup any existing `.proto` files. There may have been breaking changes, and it is much easier to compare .proto files instead of their compiled versions.
1. From the main directory, execute one of the following commands
  - `inv PullProtobufSteamMessages` will retrieve the files that (usually) do not conflict with other protobuf files.
  - `inv PullProtobufWebui` will retrieve all protobuf files which stem from the webui definitions. These files tend to conflict with the steammessages ones so watch out for errors in the protoc compilation step.
  - `inv PullAllProtobufFiles` will retrieve both the steammessages and webui files. This is the recommended command to use.


## Updating procedure
Updating the compiled protobuf files is just as easy as the following steps:
1. (Optional) Copy all existing files in `src/steam_network/protocol/messages/` to a backup directory. If you backed up the proto files in the obtain procedure, you may ignore this step. otherwise, they may be useful determining if any changes have occured.
1. Make sure you have `protoc` 3.19.x installed (you can use `inv InstallProtoc` to install a working copy into this source tree). Protobuf version 3.20 and above dropped support for Python 3.7 which we need to use because of Galaxy.
1. Run `inv GenerateProtobufMessages` will convert all `.proto` files found in the `protobuf_files/proto` directory into their `.py` form. These are placed in the `src/steam_network/protocol/messages` folder.
1. If you made a backup of messages directory, you can compare the files to see if anything changed. `Diff` or `git diff` can be useful here. If you did, skip to the next step.
1. Build the plugin and check that it works, especially features which may be affected by changes in their protobuf messages.

## Sources

* <https://github.com/steamdatabase/protobufs>
* <https://github.com/ValvePython/steam>

## Installing and generating protobufs on Mac

First time Install Python OpenSSL Certificates so the request library can pull Stream protobufs.

1. Install python 3.7 from https://www.python.org/downloads/. It puts Python in your Applications directory
2. `"/Applications/Python 3.7/Install Certificates.command"`  You must install for Python 3.7.

The README instructions have you set up a virtual environment but for some reason `inv PullProtobufSteamMessages` looks for the certicicates in the "/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/" directory, so you need both.

See info in [python - urllib.error.URLError: <urlopen error \[SSL: CERTIFICATE_VERIFY_FAILED\] certificate verify failed: unable to get local issuer certificate (_ssl.c:1108) - Stack Overflow](https://stackoverflow.com/questions/68275857/urllib-error-urlerror-urlopen-error-ssl-certificate-verify-failed-certifica#:~:text=Here%20are%20the%20steps%20for%20macOS%3A%20Open%20the,had%20to%20do%20this%20twice%20before%20it%20worked.)

Now you can run `inv PullProtobufSteamMessages` which will download and replace the protobufs checked into git.

To regenerate protobufs you must get and install the protobuf compiler.

1. `inv InstallProtoc`
2. `chmod a+x protoc/bin/protoc` # the InstallProtoc task does not set the protoc to be executable
3. `inv GenerateProtobufMessages` will now work.
